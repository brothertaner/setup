#!/bin/bash

# Bu script, önceki kurulumu geri alır.
# root kullanıcısı olarak çalıştırıldığından emin olun.

DOMAIN="n1.openssh.site"
WEBROOT="/var/www/html"
NODE_PORT=8880  # Node.js WebSocket sunucu portu
SSH_PORT=22
SSH_TLSPort=443

# 1. Node.js WebSocket servisini durdur ve kaldır
echo "Node.js WebSocket servisini durduruyor ve kaldırıyoruz..."
sudo systemctl stop websocket-server
sudo systemctl disable websocket-server
sudo rm -f /etc/systemd/system/websocket-server.service
sudo rm -rf /var/www/html/websocket-server

# 2. Let's Encrypt SSL sertifikasını kaldır
echo "Let's Encrypt SSL sertifikasını kaldırıyoruz..."
sudo certbot delete --cert-name $DOMAIN

# 3. Nginx yapılandırmasını geri al ve Nginx servisini durdur
echo "Nginx yapılandırmasını kaldırıyoruz..."
sudo rm -f /etc/nginx/sites-available/$DOMAIN
sudo rm -f /etc/nginx/sites-enabled/$DOMAIN
sudo nginx -t
sudo systemctl restart nginx

# 4. Stunnel SSH-TLS yapılandırmasını ve servisini kaldır
echo "Stunnel SSH-TLS yapılandırmasını kaldırıyoruz..."
sudo rm -f /etc/stunnel/ssh-tls.conf
sudo systemctl stop stunnel4
sudo systemctl disable stunnel4

# 5. SSH yapılandırmasını eski haline getir
echo "SSH yapılandırmasını geri alıyoruz..."
sudo sed -i 's/Port 22/#Port 22/' /etc/ssh/sshd_config
sudo sed -i 's/PermitRootLogin yes/#PermitRootLogin yes/' /etc/ssh/sshd_config
sudo systemctl restart sshd

# 6. Nginx ve gerekli paketleri kaldır
echo "Nginx ve gerekli paketleri kaldırıyoruz..."
sudo apt remove --purge -y nginx nginx-common nginx-core
sudo apt remove --purge -y certbot python3-certbot-nginx nodejs npm
sudo apt autoremove -y

# 7. Stunnel ve ilgili paketleri kaldır
echo "Stunnel paketlerini kaldırıyoruz..."
sudo apt remove --purge -y stunnel4
sudo apt autoremove -y

# 8. Firewall yapılandırmasını sıfırla
echo "Firewall yapılandırmasını sıfırlıyoruz..."
sudo ufw delete allow 22/tcp
sudo ufw delete allow 443/tcp
sudo ufw delete allow OpenSSH
sudo ufw reload

# 9. Uygulama servisi ve dosya izinlerini temizle
echo "Sistem temizliği yapılıyor..."
sudo rm -rf /etc/systemd/system/websocket-server.service
sudo rm -rf /var/www/html/websocket-server

echo "Geri alma işlemi başarıyla tamamlandı!"
